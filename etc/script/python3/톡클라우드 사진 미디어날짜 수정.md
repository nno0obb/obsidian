---
created_at: 2025/09/06 16:59:39
updated_at: 2025/09/06 18:00:57
---
```python
import json
import subprocess
from concurrent.futures import ProcessPoolExecutor, as_completed
from datetime import datetime
from pathlib import Path

from tqdm import tqdm

PATH = Path("~/Downloads").expanduser()
FAIL_LIST = []


def get_file_extension(file: Path) -> str:
    return file.suffix


def get_real_extension(file: Path) -> str:
    command = " ".join(
        [
            "exiftool",
            "-json",
            str(file),
        ]
    )
    result = subprocess.run(command, check=False, capture_output=True, shell=True, encoding="utf-8")
    json_data = json.loads(result.stdout)
    return json_data[0]["MIMEType"].split("/")[1]


def update_extension(file: Path, real_extension: str):
    filename = file.stem
    folder = file.parent
    command = " ".join(
        [
            "mv",
            str(file.resolve()),
            str(folder / (filename + "." + real_extension)),
        ]
    )
    _ = subprocess.run(command, check=False, capture_output=True, shell=True, encoding="utf-8")


def get_timestamp(file: Path) -> datetime:
    created_date = file.name.split("_")[0]
    created_time = file.name.split("_")[1].split(".")[0].split("-")[0]
    created_at = datetime.strptime(f"{created_date} {created_time}", "%Y%m%d %H%M%S")
    return created_at


def get_file_data(file: Path) -> dict:
    command = " ".join(
        [
            "exiftool",
            "-json",
            str(file),
        ]
    )
    result = subprocess.run(command, check=False, capture_output=True, shell=True, encoding="utf-8")
    json_data = json.loads(result.stdout)
    return json_data[0]


def update_timestamp(file_path: Path, timestamp: datetime):
    timestamp_str = timestamp.strftime("%Y:%m:%d %H:%M:%S")
    command = " ".join(
        [
            "exiftool",
            f"'-AllDates={timestamp_str}'",
            "-overwrite_original",
            str(file_path.resolve()),
        ]
    )
    _ = subprocess.run(command, check=False, capture_output=True, shell=True, encoding="utf-8")


def update_file(file: Path):
    file_extension = get_file_extension(file)
    real_extension = get_real_extension(file)
    if file_extension != real_extension:
        update_extension(file, real_extension)
    timestamp = get_timestamp(file)
    update_timestamp(file, timestamp)
    file_data = get_file_data(file)
    if file_data.get("DateTimeOriginal") is None:
        FAIL_LIST.append(file)


def update_file_all():
    with ProcessPoolExecutor() as ex:
        futures = []
        for file in PATH.iterdir():
            if file.is_file():
                if file.suffix not in [".jpg", ".jpeg", ".png", ".gif", ".mp4"]:
                    continue
                futures.append(ex.submit(update_file, file))

        for future in tqdm(as_completed(futures), total=len(futures)):
            future.result()

    if FAIL_LIST:
        print(f"FAIL_LIST: {FAIL_LIST}")


def main():
    update_file_all()


if __name__ == "__main__":
    main()

```